# housing-sim-jp

**20〜40代・世帯年収1,000〜2,000万の共働きカップル**が、マンション購入・一戸建て購入・賃貸のどれが最も資産形成に有利かを、80歳までの月次シミュレーションで比較するツール。

物件価格・家賃は**さいたま市浦和区の実勢価格**（2026年）をハードコードしており、都心タワマンや地方物件には対応していない。初期資産3億超（浦和最高級物件が現金購入可能な水準）や世帯年収600万以下の世帯は想定外。確定論（固定リターン）とMonte Carlo（確率分布+生活イベントリスク）の2モードを持つ。

## 比較戦略

| 戦略 | 概要 |
|------|------|
| **浦和マンション** | 築10年中古マンション購入（7,580万円）。管理費+修繕積立金が築年数で段階増額 |
| **浦和一戸建て** | 築7年中古一戸建て購入（6,547万円）。大規模修繕を一時費用で計上 |
| **戦略的賃貸** | ライフステージに応じて3フェーズで家賃ダウンサイジング（2LDK→3LDK→2LDK） |
| **通常賃貸** | 3LDK固定で全期間賃貸 |

## 使い方

```bash
# 単体シミュレーション（確定論: 4戦略比較）
python -m housing_sim_jp.cli

# 5シナリオ×4戦略比較（確定論: 低成長/標準/高成長/慢性スタグフレーション/サイクル型 + 投資規律の感度分析）
python -m housing_sim_jp.scenario_cli

# カスタム条件
python -m housing_sim_jp.cli --husband-age 37 --wife-age 35 --savings 1500 --husband-income 45 --wife-income 30
python -m housing_sim_jp.cli --pets 38,40 --car           # ペット2匹（夫38歳・40歳迎え入れ）+車
python -m housing_sim_jp.cli --special-expenses 55:500,65:300  # 特別支出

# Monte Carlo シミュレーション（確率論: N=1,000試行 + イベントリスク）
python -m housing_sim_jp.monte_carlo_cli
python -m housing_sim_jp.monte_carlo_cli --stress-test   # ストレステスト追加出力

# テスト
python -m pytest tests/ -v
```

### 設定ファイル

`config.example-*.toml` をコピーして `config.toml` を作成すると、CLIフラグのデフォルト値を上書きできます。

```bash
cp config.example-25.toml config.toml   # 25歳プリセット（250万/手取り57万/子2人/生活費P3万）
cp config.example-30.toml config.toml   # 30歳プリセット（600万/手取り67万/子2人/生活費P3万/ペット1匹）
cp config.example-35.toml config.toml   # 35歳プリセット（1200万/手取り74万/子1人/生活費P3万/中学〜私立理系/車）
python -m housing_sim_jp.cli                              # config.toml を自動読み込み
python -m housing_sim_jp.cli --config my_config.toml      # 任意のパスを指定
python -m housing_sim_jp.cli --config config.toml --husband-age 40  # CLIフラグで個別に上書き
```

**優先順位**: CLIフラグ > config.toml > ハードコードデフォルト

### オプション（全CLI共通）

| フラグ | 説明 | デフォルト |
|--------|------|-----------|
| `--config` | 設定ファイルパス | config.toml（存在時のみ） |
| `--husband-age` | 夫の開始年齢（20〜45歳） | 30 |
| `--wife-age` | 妻の開始年齢（20〜45歳） | 28 |
| `--savings` | 初期金融資産（万円） | 800 |
| `--husband-income` | 夫の月額手取り（万円） | 40.0 |
| `--wife-income` | 妻の月額手取り（万円） | 22.5 |
| `--children` | 出産時の妻の年齢（カンマ区切り、最大2人、`none`で子なし） | 30,33 |
| `--living-premium` | 生活費プレミアム（年齢別ベースラインへの上乗せ、万円/月） | 0.0 |
| `--child-living` | 子1人あたりの追加生活費（万円/月） | 5.0 |
| `--education-private-from` | 私立切替ステージ（`""`, `中学`, `高校`, `大学`） | `""`（全公立） |
| `--education-field` | 進路（`理系`, `文系`） | `理系` |
| `--education-boost` | 受験年（小6/中3/高3）費用倍率 | 1.0 |
| `--education-grad` | 最終学歴（`学部`, `修士`, `博士`）→全子供に一括適用 | `学部` |
| `--car` | 車所有（購入300万/7年買替+維持費5万/月を計上） | なし |
| `--pets` | ペット迎え入れ時の夫の年齢（カンマ区切り、1匹15年・飼育費1.5万/月、賃貸は+1.5万/月） | なし |
| `--relocation` | 転勤族モード（転勤確率が年3%→10%に上昇） | なし |
| `--husband-ideco` | 夫のiDeCo拠出額（万円/月、0で無効） | 2.0 |
| `--wife-ideco` | 妻のiDeCo拠出額（万円/月、0で無効） | 2.0 |
| `--emergency-fund` | 生活防衛資金（生活費の何ヶ月分、0で無効） | 6.0 |
| `--special-expenses` | 特別支出（`年齢:金額[:ラベル]`のカンマ区切り、例: `55:500:リフォーム,65:300`） | なし |

### Monte Carlo 固有オプション

| フラグ | 説明 | デフォルト |
|--------|------|-----------|
| `--mc-runs` | シミュレーション回数 | 1000 |
| `--volatility` | 投資リターンのボラティリティ σ | 0.15 |
| `--loan-volatility` | 金利シフトのボラティリティ σ | 0.005 |
| `--seed` | 乱数シード | 42 |
| `--no-events` | イベントリスクを無効化 | 有効 |
| `--stress-test` | ストレステスト表を追加出力 | なし |

## 前提条件

### 世帯・ライフプラン

- **対象世帯**: 一都三県勤務の共働きカップル（夫婦別年齢対応）、大手企業正社員
- **居住エリア**: 職住近接・都心まで30分以内（浦和駅エリア想定）
- **シミュレーション期間**: 開始年齢（20〜45歳）から80歳まで。80歳で老人ホーム入居を出口戦略とし、以降のバリアフリー改修等は考慮外

### 教育費（4トラック年次スケジュール方式）

子の7〜独立年齢の期間に、4トラック（国立文系/国立理系/私立文系/私立理系）の年次コストデータで計上。小学校は全トラック公立共通。

| トラック | 小(7-12) | 中(13-15) | 高(16-18) | 大(19-22) | 学部計 |
|---------|---------|---------|---------|---------|---------|
| 国立文系 | 400万 | 240万 | 270万 | 290万 | **1,200万** |
| 国立理系 | 400万 | 240万 | 290万 | 300万 | **1,230万** |
| 私立文系 | 400万 | 360万 | 390万 | 480万 | **1,630万** |
| 私立理系 | 400万 | 390万 | 430万 | 680万 | **1,900万** |

- **トラック選択**: `--education-private-from` で私立開始ステージを指定。`--education-field` で理系/文系を選択
- **受験年加算**: `--education-boost 1.2` で小6/中3/高3の費用が×1.2（塾・予備校の積極投資）
- **大学院進学**: `--education-grad 修士` で全子供の独立年齢が24歳に延長（博士は27歳）
- **生活費**: 年齢別ベースライン（20歳20万→35歳29万→50歳以降27.5万）＋プレミアム（`--living-premium`）＋子供1人あたり追加分で動的計算
- **子なし**: `--children none`（TOMLでは `children = []`）で教育費・子供生活費ゼロ
- **子供上限**: 3LDKの部屋数制約により最大2人

### 児童手当

2024年改正の児童手当（所得制限撤廃・18歳まで延長）を固定名目額で計上。子1人あたり約246万円（0-2歳:1.5万×36ヶ月 + 3-18歳:1.0万×192ヶ月）。インフレ非連動の法定額のため、CLI/TOMLパラメータにはしていない。住宅ローン審査の収入には含めない。

### 収入・年金

- **収入モデル**: 夫婦各人の月額手取りを入力。賃金構造基本統計調査ベースの5段階キャリアカーブ（20代+3.0%→30代+2.0%→40代+1.0%→50-54歳±0%→55-59歳-3.0%）で55歳ピーク。これに名目賃金上昇率（標準2.0%/年）を重畳。60歳で再雇用（ピークの60%）、70歳で年金生活
- **年金**: 夫婦各人のピーク収入から公的年金（基礎年金+厚生年金）を個別計算し合算 + 企業年金（デフォルト130万/年、初期収入比率で按分）

### 住宅購入

- **物件価格**: 2026年の浦和駅エリア実勢価格
- **住宅ローン**: フルローン35年・変動金利（5年ごとステップ式）。銀行審査基準（年収倍率≤7倍、返済比率≤35%）を適用
- **初期資産**: 購入戦略の諸費用（マンション606万・一戸建て524万・賃貸105万）を賄えること

### 資産運用・税務

- **投資口座**: iDeCo → NISA → 特定口座の順で投資。取り崩しは逆順
  - **iDeCo**: 夫婦各人が60歳まで拠出（デフォルト各2万/月）、毎月の税軽減（各人の拠出額×各人の限界税率）を投資に加算。各人71歳で一時金受取（退職金と1年以上ずらす税務最適化、退職所得控除適用後に課税）
  - **NISA**: 夫婦合計3,600万円上限・非課税
  - **特定口座**: NISA超過分（課税20.315%）
- **不動産売却**: 居住用財産3,000万円特別控除を適用

### 生活防衛資金

生活費の6ヶ月分を現金で確保し投資に回さない（`--emergency-fund` で月数を変更可）。子の在宅状況・退職・離婚/死亡に応じて動的に調整。初期資産から控除されるため、特に初期資産が小さいケースでは運用元本への影響が大きい。

### 施設グレード判定（80歳出口）

80歳入居→110歳（20年本体＋10年長寿バッファ）前提の入居審査モデル。運用利回り0%、**年金収入で月額費用を控除**（実態の入居審査に準拠）。

| グレード | 必要資産（年金控除前） | 入居一時金 | 月額合計 | 参考施設 |
|---------|---------------------|-----------|---------|---------|
| S（超高級） | ≥4.42億 | 2億円 | 80万円 | パークウェルステイト西麻布、サクラビア成城最上位 |
| A（高級） | ≥2.94億 | 1億円 | 63万円 | サクラビア成城標準、パークウェルステイト浜田山 |
| B（準高級） | ≥2.04億 | 5,000万円 | 50万円 | アリア高輪、グランクレール成城 |
| C（標準） | ≥1.19億 | 2,000万円 | 32万円 | LIFULL高級施設中央値帯 |
| D（エコノミー） | ≥0.77億 | 500万円 | 23万円 | 首都圏一般介護付き有料老人ホーム |

## 経済シナリオ

| パラメータ | 低成長 | 標準 | 高成長 | 慢性スタグフレーション | サイクル型 * |
|-----------|--------|------|--------|----------------------|------------|
| インフレ率 | 1.0% | 2.0% | 3.0% | 2.0% | 2.3% |
| 賃金上昇率 | 1.0% | 2.0% | 3.0% | 1.5% | 1.7% |
| 実質賃金 | ±0% | ±0% | ±0% | -0.5% | -0.6% |
| 運用利回り | 5.0% | 6.0% | 7.5% | 4.5% | 5.1% |
| 土地上昇率 | 0.0% | 0.75% | 1.5% | 0.0% | 0.2% |
| ローン金利 | 0.50→1.25% | 0.75→2.50% | 1.25→3.50% | 0.75→2.25% | 0.90→2.75% |

\* **サイクル型**: 7年通常（利回り6.0%/インフレ2.0%/賃金2.0%）+ 3年スタグフレーション（利回り3.0%/インフレ3.0%/賃金1.0%）の10年サイクル。表中の値は加重平均。投資リターンのみ年次変動あり。

## Monte Carlo シミュレーション

確定論モデル（固定リターン6.0%）では見えない**市場変動リスク**と**生活イベントリスク**を定量化する。

**市場変動（年次サンプリング）:**
- 投資リターン: 対数正規分布（期待値6.0%、σ=15%）— 年ごとに変動
- インフレ率・土地上昇率: 正規分布（ラン単位で固定、相関0.6）
- 賃金上昇率: インフレとの条件付き正規分布（相関0.8、σ=0.005）
- 金利シフト: インフレとの条件付き正規分布（ラン単位で `loan_rate_schedule` 全体に一律加算、相関0.7）。σ=0で確定論と同一

**生活イベント（事前サンプリング）:**
- 失業（年2%、6ヶ月間収入ゼロ、最大2回）
- 災害（年0.5%、物件価値30%毀損・保険50%カバー）
- 介護（75歳以降年5%、月15万円）
- 入居拒否（70歳以降年10%、賃貸のみ月5万円追加）
- 離婚（年1%、資産50%分割＋物件売却、年金期以降は発生停止）
- 配偶者死亡（年0.3%、団信でローン消滅＋生命保険3,000万＋遺族年金75万/年）
- 転勤（年3%、60歳未満・最大1回。購入→物件売却+同等物件再購入（売却手数料+購入諸費用の二重負担）、賃貸→引越し費用のみ。`--relocation`で年10%に上昇）

離婚と配偶者死亡は排他的（先に発生した方のみ有効）。転勤は独立して発生。

**出力:** P5/P25/P50/P75/P95のパーセンタイル分布、元本割れ確率（運用資産が初期貯蓄の複利成長を下回る確率）、破綻確率、ストレステスト結果

## チャート生成

```bash
# 確定論+MC（デフォルト: reports/charts/ に出力）
python -m housing_sim_jp.chart_cli
python -m housing_sim_jp.chart_cli --config config.example-35.toml --name 35

# 確定論のみ（高速）
python -m housing_sim_jp.chart_cli --no-mc

# MC試行数・出力先を指定
python -m housing_sim_jp.chart_cli --mc-runs 500 --output reports/charts/
```

## レポート自動生成

テンプレートエンジンで7章構成のMarkdownレポートを自動生成する。確定論・5シナリオ比較・Monte Carlo・ストレステストの全結果を含む。

```bash
# 単一レポート生成
python -m housing_sim_jp.report_cli --config config.example-30.toml --name 30

# 4設定一括生成（config.toml + 3つのexample）
python -m housing_sim_jp.report_cli --all

# 高速モード（MC省略、構造確認用）
python -m housing_sim_jp.report_cli --config config.toml --no-mc

# MC試行数・シード指定
python -m housing_sim_jp.report_cli --config config.toml --mc-runs 2000 --seed 123
```

| フラグ | 説明 | デフォルト |
|--------|------|-----------|
| `--config` | TOML設定ファイル | config.toml |
| `--name` | サフィックス（`30` → `report-30.md`, `*-30.png`） | なし |
| `--all` | 4設定ループ（config.toml + example-25/30/35） | — |
| `--no-mc` | Monte Carlo省略（第4章をスキップ） | 有効 |
| `--mc-runs` | MC試行数 | 1000 |
| `--seed` | 乱数シード | 42 |
| `--output` | レポート出力ディレクトリ | reports |
| `--chart-dir` | チャート出力ディレクトリ | reports/charts |

### レポート構成

| 章 | 内容 |
|----|------|
| §1 | 前提条件（マクロ5シナリオ・世帯プロファイル・所得推移テーブル・教育費・パラメータ妥当性チェック） |
| §2 | 戦略の仕組み（物件コスト構造・修繕計画・ローン条件・賃貸フェーズ設計） |
| §3 | 確定論ベースライン（5シナリオ×4戦略・主要転換点・感度分析） |
| §4 | Monte Carlo分布（パーセンタイル・ストレステスト・イベントリスク影響）— `--no-mc` で省略 |
| §5 | 数値に現れない特性（流動性・居住の質・リスク耐性の定性評価） |
| §6 | 出口戦略（80歳施設入居のグレード判定 S/A/B/C） |
| §7 | 結論（総合比較表・破綻確率に基づく段階的警告・リスク認識） |

## 分析レポート

| レポート | 条件 |
|---------|------|
| [reports/report-25.md](reports/report-25.md) | 夫25歳/妻24歳・金融資産250万・手取り57万（夫34+妻23）・子2人（妻27,30歳出産）・高校〜私立理系・生活費P3万 |
| [reports/report-30.md](reports/report-30.md) | 夫30歳/妻28歳・金融資産600万・手取り67万（夫40+妻27）・子2人（妻31,33歳出産）・高校〜私立理系・生活費P3万・ペット1匹 |
| [reports/report-35.md](reports/report-35.md) | 夫35歳/妻32歳・金融資産1200万・手取り74万（夫44+妻30）・子1人（妻35歳出産）・中学〜私立理系・生活費P3万・車 |